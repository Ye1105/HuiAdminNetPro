@model Dictionary<string,string>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>welcome</title>
    <link type="text/css" rel="stylesheet" href="~/layuiadmin/layui/css/layui.css" media="all" />
    <link type="text/css" rel="stylesheet" href="~/layuiadmin/style/admin.css" media="all">
</head>
<body>
    <div class="layui-fluid">
        <div class="layui-fluid">
            <div class="layui-card">
                <div class="layui-card-body">
                    <div class="layui-form" id="routes" lay-filter="LAY-route">
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
<script type="text/javascript" src="~/layuiadmin/layui/layui.js"></script>
<script type="text/javascript">
    layui.config({
        base: '../layuiadmin/' //静态资源所在路径
    }).extend({
        index: 'lib/index' //主入口模块
    }).use(function () {

        let $ = layui.$,
            form = layui.form;

        var rId = `@(Model["rId"])`;

        getRoute(rId);

        async function getRoute(rId) {
            let loadIndex = layer.load(0);
            await fetch(`/api/routes?rId=${rId}`)
                .then(response => response.json())
                .then(result => {
                    layer.close(loadIndex);
                    if (result.status == 200) {
                        //解构赋值
                        let { routes, permissions } = result.data;

                        //顶级节点
                        let pr = routes.filter(x => x.pId == "00000000-0000-0000-0000-000000000000");
                        //console.log(pr)
                        let renderHtml = '';
                        pr.forEach(x => {
                            renderHtml += `<div class="layui-form-item"><dl class="permission-list">`
                           
                            let prc = permissions.filter(n => n.adminRoute.pId == x.id);
                            renderHtml += `<dt><input type="checkbox" name="${x.id}_1" title=${x.name} ${prc.length > 0 ? "checked" : ""}></dt>`

                            //当前顶级节点的所有次级节点
                            let su = routes.filter(v => v.pId == x.id)
                            //console.log(su)

                            su.forEach(m => {
                                renderHtml += '<dd style="margin-left:30px">'

                                let suPermission = permissions.filter(n => n.mId == m.id);
                                //查询
                                let r = suPermission.filter(n => n.cId == @((sbyte)CrudType.READ)).length
                                //添加
                                let c = suPermission.filter(n => n.cId == @((sbyte)CrudType.CREATE)).length
                                //更新
                                let u = suPermission.filter(n => n.cId == @((sbyte)CrudType.UPDATE)).length
                                //删除
                                let d = suPermission.filter(n => n.cId == @((sbyte)CrudType.DELETE)).length

                                renderHtml += `<input type="checkbox" title="${m.name}" ${suPermission.length > 0 ? "checked" : ""}>`

                                renderHtml += `<input type="checkbox" name="${m.id}_1" title="查询" ${r > 0 ? "checked" : ""}>`
                                renderHtml += `<input type="checkbox" name="${m.id}_0" title="添加" ${c > 0 ? "checked" : ""}>`
                                renderHtml += `<input type="checkbox" name="${m.id}_2" title="修改" ${u > 0 ? "checked" : ""}>`
                                renderHtml += `<input type="checkbox" name="${m.id}_3" title="删除" ${d > 0 ? "checked" : ""}>`
                                renderHtml += '</dd>'
                            })
                            renderHtml += `</dl></div>`
                        })


                        $("#routes").html(renderHtml)

                        form.render();
                    } else {
                        layer.msg(result.uimsg);
                    }
                })
                .catch(function (ex) {
                    layer.close(loadIndex);
                    console.log('parsing failed', ex);
                })
        }
    })
</script>